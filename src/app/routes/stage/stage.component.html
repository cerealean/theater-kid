<div class="min-h-[calc(100vh-56px)] grid grid-rows-[auto_1fr_auto]">
  <header class="sticky top-0 z-10 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-screen-xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <div class="font-semibold tracking-wide">ðŸŽ­ Theater Kid â€” Stage</div>

      <select class="tk-input px-2 py-2" [(ngModel)]="providerValue">
        <option value="openrouter">OpenRouter (OAuth)</option>
        <option value="openai">OpenAI (BYOK)</option>
      </select>

      <input class="tk-input px-3 py-2 w-64" placeholder="Model (e.g. openai/gpt-4o-mini)" [(ngModel)]="modelValue" />

      <div class="ml-auto flex items-center gap-2">
        <ng-container *ngIf="provider() === 'openrouter'; else openaiKey">
          <button class="tk-btn" (click)="connectOpenRouter()">Connect OpenRouter</button>
        </ng-container>
        <ng-template #openaiKey>
          <input class="tk-input px-3 py-2" placeholder="OpenAI API Key" type="password" (keydown.enter)="saveOpenAIKey($any($event.target).value)"/>
          <button class="tk-btn" (click)="saveOpenAIKey(($any($event.target).previousElementSibling.value))">Save</button>
        </ng-template>

        <label class="inline-flex items-center gap-2 text-sm">
          <input type="checkbox" class="tk-input" [checked]="streaming()" (change)="streaming.set($any($event.target).checked)"/>
          stream
        </label>
      </div>
    </div>
  </header>

  <main class="overflow-auto">
    <div class="max-w-screen-md mx-auto p-4 space-y-3">
      <div *ngFor="let m of messages(); let i = index" class="flex">
        <div class="max-w-[80ch] w-fit px-4 py-3 rounded-bubble shadow-stage border border-white/10"
             [ngClass]="{
               'ml-auto': m.role === 'user',
               'bg-white/5': m.role !== 'assistant',
               'bg-primary/10': m.role === 'assistant'
             }">
          <div class="text-xs opacity-70 mb-1" *ngIf="m.role==='system'">System</div>
          <div class="prose prose-invert max-w-none" [innerHTML]="md.render(m.content)"></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t border-white/10">
    <div class="max-w-screen-md mx-auto p-4">
      <textarea class="tk-input w-full p-3" rows="4" 
                placeholder="Type and hit Sendâ€¦ (Shift+Enter newline)" 
                [(ngModel)]="inputValue" 
                (keydown.enter)="onEnterKey($any($event))"></textarea>
      <div class="mt-2 flex items-center justify-end gap-2">
        <input class="tk-input px-3 py-2 w-full" 
               placeholder="(optional) System prompt for this scene" 
               [(ngModel)]="systemValue"/>
        <button class="tk-btn" (click)="send()" [disabled]="busy()">Send</button>
      </div>
    </div>
  </footer>
</div>